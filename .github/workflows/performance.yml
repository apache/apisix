name: Performance Test

on:
  push:
    branches: [flamegraph]
#  pull_request:
#    branches: [master, 'release/**']
#    paths-ignore:
#      - 'docs/**'
#      - '**/*.md'

jobs:
  performance:
    if: github.repository == 'tzssangglass/apisix'
    runs-on: ubuntu-18.04
    timeout-minutes: 90

    steps:
      - name: Check out code
        uses: actions/checkout@v2.4.0
        with:
          submodules: recursive

#      - name: Cache deps
#        uses: actions/cache@v2.1.7
#        env:
#          cache-name: cache-deps
#        with:
#          path: deps
#          key: ${{ runner.os }}-${{ env.cache-name }}-${{ matrix.os_name }}-${{ hashFiles('rockspec/apisix-master-0.rockspec') }}

#      - name: Install Dependencies
#        run: sudo ./ci/performance_test.sh install_dependencies
#
#      - name: Install wrk2
#        run: sudo ./ci/performance_test.sh install_wrk2
#
#      - name: Install SystemTap Tools
#        run: sudo ./ci/performance_test.sh install_stap_tools
#
#      - name: Perf Test
#        run: ./ci/performance_test.sh run_performance_test
#
#      - name: Upload Performance Test Result
#        uses: actions/upload-artifact@v2
#        with:
#          name: perf.txt
#          path: |
#            output/performance.txt
#          retention-days: 3
#
#      - name: Upload flamegrpah
#        uses: actions/upload-artifact@v2
#        with:
#          name: flamegraph.svg
#          path: |
#            output/flamegraph.svg
#          retention-days: 3

      - name: Echo Result
        run: |
          curl -X POST \
          -H 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
          -H 'Accept: application/vnd.github.v3+json' \
          https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
          --data '{"test":"test"}'
