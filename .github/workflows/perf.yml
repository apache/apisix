name: Perf

on:
  push:
    branches: [flamegraph]
  schedule:
    - cron:  '0 0 * * *'

jobs:
  perf:
    runs-on: ubuntu-18.04
    timeout-minutes: 90

    steps:
      - name: Check out code
        uses: actions/checkout@v2.4.0
        with:
          submodules: recursive

      - name: Cache deps
        uses: actions/cache@v2.1.7
        env:
          cache-name: cache-deps
        with:
          path: deps
          key: ${{ runner.os }}-${{ env.cache-name }}-${{ matrix.os_name }}-${{ hashFiles('rockspec/apisix-master-0.rockspec') }}

      - name: Install Dependencies
        run: sudo ./ci/perf.sh install_dependencies

      - name: Install wrk2
        run: sudo ./ci/perf.sh install_wrk2

      - name: Perf Test
        run: ./ci/perf.sh run_perf_test
